import os
import oracledb
from flask_sqlalchemy import SQLAlchemy
from flask import current_app

db = SQLAlchemy()


def init_sqlalchemy(app=None) -> None:
    """
    Initialise SQLAlchemy pour une base Oracle avec pool de connexions.

    Variables d'environnement utilisées :
        ORACLE_USER
        ORACLE_PASSWORD
        ORACLE_HOST            (défaut: localhost)
        ORACLE_PORT            (défaut: 1521)
        ORACLE_SERVICE_NAME    ou ORACLE_SID
        ORACLE_CLIENT_LIB_DIR  (optionnel)
        ORACLE_CONFIG_DIR      (optionnel)

        DB_POOL_SIZE           (défaut: 5)
        DB_MAX_OVERFLOW        (défaut: 10)
        DB_POOL_TIMEOUT        (défaut: 30 sec)
        DB_POOL_RECYCLE        (défaut: 1800 sec)
    """
    if app is None:
        app = current_app

    # --- Initialisation du client Oracle (optionnelle) ---
    kw = {}
    lib_dir = os.getenv("ORACLE_CLIENT_LIB_DIR")
    config_dir = os.getenv("ORACLE_CONFIG_DIR")
    if lib_dir:
        kw["lib_dir"] = lib_dir
    if config_dir:
        kw["config_dir"] = config_dir

    if kw:
        try:
            oracledb.init_oracle_client(**kw)
        except oracledb.ProgrammingError:
            # déjà initialisé → on ignore
            pass

    # --- Construction de l'URL SQLAlchemy ---
    user = os.environ.get("ORACLE_USER")
    password = os.environ.get("ORACLE_PASSWORD")
    host = os.getenv("ORACLE_HOST", "localhost")
    port = os.getenv("ORACLE_PORT", "1521")
    service_name = os.environ.get("ORACLE_SERVICE_NAME")
    sid = os.environ.get("ORACLE_SID")

    if not user or not password:
        raise RuntimeError("ORACLE_USER et ORACLE_PASSWORD doivent être définis.")

    if service_name:
        dsn = f"{host}:{port}/?service_name={service_name}"
    elif sid:
        dsn = f"{host}:{port}/{sid}"
    else:
        raise RuntimeError("Définir ORACLE_SERVICE_NAME ou ORACLE_SID.")

    db_uri = f"oracle+oracledb://{user}:{password}@{dsn}"

    # --- Pool de connexions SQLAlchemy ---
    pool_size = int(os.getenv("DB_POOL_SIZE", "5"))
    max_overflow = int(os.getenv("DB_MAX_OVERFLOW", "10"))
    pool_timeout = int(os.getenv("DB_POOL_TIMEOUT", "30"))
    pool_recycle = int(os.getenv("DB_POOL_RECYCLE", "1800"))

    engine_options = {
        "pool_pre_ping": True,        # vérifie la connexion avant utilisation
        "pool_size": pool_size,
        "max_overflow": max_overflow,
        "pool_timeout": pool_timeout,
        "pool_recycle": pool_recycle,
    }

    # --- Configuration de Flask / SQLAlchemy ---
    app.config.setdefault("SQLALCHEMY_DATABASE_URI", db_uri)
    app.config.setdefault("SQLALCHEMY_TRACK_MODIFICATIONS", False)
    app.config.setdefault("SQLALCHEMY_ENGINE_OPTIONS", engine_options)

    db.init_app(app)
