#! /bin/bash
set -x
PIDFILE=$FRAUD_RUN/gunicorn.pid
START=0
export PYTHONPATH="${PYTHONPATH}:${FRAUD_BIN}"
export LC_ALL=fr_FR.UTF-8
if test -f "$PIDFILE"; then
	GUNI_PID=`cat $PIDFILE`
	ListeProcess=`ps -ef | grep $GUNI_PID | grep -v grep | wc -l`
	if [ "$ListeProcess" == "0" ]; then
		START=1
	else
		echo "gunicorn is already started on {$GUNI_PID} if you want to restart it please stop it first"
		exit 0
	fi
else
	START=1
fi

if [ $START -eq 1 ]; then
	echo "Starting gunicorn"
	source $FRAUD_VENV/bin/activate
	find $FRAUD_BIN | grep -E "(__pycache__|\.pyc|\.pyo$)" | xargs rm -rf
	find $FRAUD_CONF | grep -E "(_pycache__|\.pyc|\.pyo$)" | xargs rm -rf
	gunicorn --config $FRAUD_CONF/fraud_ws_config.py --chdir $FRAUD_BIN web:app &
	deactivate
	echo "..."
	sleep 10
	$FRAUD_BIN/Status_gunicorn.sh
fi
