#!/bin/ksh
##############################################################################
#  AttachmentIntegratorApi - Stop Script (final version)
#
#  âš™ï¸ UTILISATION EN PRODUCTION AVEC SYSTEMD :
#  -------------------------------------------------------------------------
#    - Ce script est appelÃ© par systemd ou manuellement :
#        sudo systemctl stop attachementintegratorapi.service
#      (ou directement : ./Stop.sh)
#
#  âš™ï¸ IMPACT SYSTEMD (aucun changement requis)
#  -------------------------------------------------------------------------
#    - Gunicorn gÃ¨re lui-mÃªme le socket UNIX sâ€™il est activÃ©.
#    - systemd nâ€™a pas besoin dâ€™un fichier .socket dÃ©diÃ©.
#    - Vous pouvez, si besoin, sÃ©parer les unitÃ©s (.socket / .service)
#      pour du socket-activation, mais ce nâ€™est PAS nÃ©cessaire ici.
#
#  ðŸ§· MODE SOCKET UNIX :
#  -------------------------------------------------------------------------
#    - USE_UNIX_SOCKET=true dans conf/.env
#    - bind unix activÃ© dans conf/gunicorn_conf.py
#    - Ce script supprime le socket automatiquement Ã  l'arrÃªt.
#
#  â±ï¸ DÃ‰LAI D'ARRÃŠT GRACIEUX :
#  -------------------------------------------------------------------------
#    - On envoie SIGQUIT (graceful), puis SIGTERM, puis SIGKILL si besoin.
#    - DÃ©lai d'attente = (API_NB_WORKERS * API_NB_THREADS) + marge (3s)
#    - Minimum 5 secondes.
##############################################################################

umask 027

# --------- Charger l'environnement ---------
ENV_FILE="$(dirname "$0")/../conf/.env"
if [ ! -f "${ENV_FILE}" ]; then
  echo "[ERROR] conf/.env introuvable"
  exit 1
fi
. "${ENV_FILE}"

# --------- Variables dÃ©rivÃ©es ---------
PID_FILE="${API_RUN}/${API_NAME}.pid"
SOCK_FILE="${API_SOCK}"

# --------- Fonction utilitaire ---------
is_alive() {
  PID="$1"
  [ -n "${PID}" ] && ps -p "${PID}" >/dev/null 2>&1
}

# --------- Si pas de PID -> rien Ã  arrÃªter ---------
if [ ! -f "${PID_FILE}" ]; then
  echo "[INFO] ${API_NAME}: aucun PID trouvÃ© (dÃ©jÃ  arrÃªtÃ© ?)"
  if [ "${USE_UNIX_SOCKET}" = "true" ] && [ -S "${SOCK_FILE}" ]; then
    echo "[INFO] Suppression du socket rÃ©siduel: ${SOCK_FILE}"
    rm -f "${SOCK_FILE}" >/dev/null 2>&1
  fi
  exit 0
fi

PID="$(cat "${PID_FILE}" 2>/dev/null)"

# --------- Cas PID vide ---------
if [ -z "${PID}" ]; then
  echo "[INFO] Fichier PID vide, nettoyage..."
  rm -f "${PID_FILE}" >/dev/null 2>&1
  if [ "${USE_UNIX_SOCKET}" = "true" ] && [ -S "${SOCK_FILE}" ]; then
    echo "[INFO] Suppression du socket rÃ©siduel: ${SOCK_FILE}"
    rm -f "${SOCK_FILE}" >/dev/null 2>&1
  fi
  exit 0
fi

# --------- Process dÃ©jÃ  mort -> nettoyage ---------
if ! is_alive "${PID}"; then
  echo "[INFO] ${API_NAME}(${PID}): dÃ©jÃ  arrÃªtÃ© (PID obsolÃ¨te)"
  rm -f "${PID_FILE}" >/dev/null 2>&1
  if [ "${USE_UNIX_SOCKET}" = "true" ] && [ -S "${SOCK_FILE}" ]; then
    echo "[INFO] Suppression du socket rÃ©siduel: ${SOCK_FILE}"
    rm -f "${SOCK_FILE}" >/dev/null 2>&1
  fi
  exit 0
fi

# --------- Calcul du dÃ©lai gracieux ---------
W=${API_NB_WORKERS}
T=${API_NB_THREADS}
MARGE=3
GRACE_WAIT=$(( W * T + MARGE ))
[ ${GRACE_WAIT} -lt 5 ] && GRACE_WAIT=5

echo "[INFO] Tentative d'arrÃªt gracieux (${API_NAME}, PID=${PID})"
echo "[INFO] Envoi SIGQUIT (graceful), attente max ${GRACE_WAIT}s ..."
kill -QUIT "${PID}" 2>/dev/null || true

i=0
while [ $i -lt ${GRACE_WAIT} ]; do
  if ! is_alive "${PID}"; then
    echo "[OK] ${API_NAME}(${PID}) arrÃªtÃ© proprement (SIGQUIT)"
    rm -f "${PID_FILE}" >/dev/null 2>&1
    if [ "${USE_UNIX_SOCKET}" = "true" ] && [ -S "${SOCK_FILE}" ]; then
      echo "[INFO] Suppression du socket: ${SOCK_FILE}"
      rm -f "${SOCK_FILE}" >/dev/null 2>&1
    fi
    exit 0
  fi
  sleep 1; i=$((i+1))
done

# --------- SIGTERM (forcÃ© si toujours vivant) ---------
echo "[WARN] ${API_NAME}(${PID}) toujours actif aprÃ¨s ${GRACE_WAIT}s -> envoi SIGTERM"
kill -TERM "${PID}" 2>/dev/null || true
sleep 2

if is_alive "${PID}"; then
  echo "[WARN] SIGTERM inefficace -> envoi SIGKILL"
  kill -KILL "${PID}" 2>/dev/null || true
  sleep 1
fi

# --------- Nettoyage final ---------
if ! is_alive "${PID}"; then
  echo "[OK] ${API_NAME}(${PID}) arrÃªtÃ© (forcÃ©)"
  rm -f "${PID_FILE}" >/dev/null 2>&1
  if [ "${USE_UNIX_SOCKET}" = "true" ] && [ -S "${SOCK_FILE}" ]; then
    echo "[INFO] Suppression du socket: ${SOCK_FILE}"
    rm -f "${SOCK_FILE}" >/dev/null 2>&1
  fi
  exit 0
else
  echo "[ERROR] ${API_NAME}(${PID}): arrÃªt Ã©chouÃ©, process toujours actif"
  exit 1
fi
