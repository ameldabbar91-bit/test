#!/bin/ksh
##############################################################################
#  AttachmentIntegratorApi - Start Script (final clean)
#
#  âš™ï¸ UTILISATION RECOMMANDÃ‰E EN PRODUCTION : via systemd (sans --daemon)
#  -------------------------------------------------------------------------
#    1) Copier le fichier service :
#         /srv/FircoContinuity/data/new/AttachmentIntegratorApi/conf/attachementintegratorapi.service
#         â†’ /etc/systemd/system/attachementintegratorapi.service
#    2) Recharger systemd :
#         sudo systemctl daemon-reload
#    3) Activer et dÃ©marrer :
#         sudo systemctl enable --now attachementintegratorapi.service
#    4) Logs :
#         sudo journalctl -u attachementintegratorapi.service -f
#
#  ðŸ§· MODE SOCKET UNIX (optionnel)
#  -------------------------------------------------------------------------
#    - Dans conf/.env : USE_UNIX_SOCKET=true
#    - Dans conf/gunicorn_conf.py :
#         commentez le bind TCP et dÃ©commentez :
#             bind = f"unix:{API_SOCK}"
#    - Configurer Nginx pour pointer vers le socket UNIX.
#    - Stop.sh supprimera automatiquement le socket Ã  lâ€™arrÃªt.
#
#  â±ï¸ max_wait (dÃ©lai de validation du dÃ©marrage)
#  -------------------------------------------------------------------------
#    - Calcul = (API_NB_WORKERS * API_NB_THREADS) + marge (3s)
#    - Exemple : 2w * 1t â†’ 5s / 4w * 2t â†’ 11s
#    - Chaque worker peut prendre ~0.5â€“1s Ã  dÃ©marrer (Oracle, libsâ€¦)
#
##############################################################################

umask 027

# --------- Charger l'environnement ---------
ENV_FILE="$(dirname "$0")/../conf/.env"
if [ ! -f "${ENV_FILE}" ]; then
  echo "[ERROR] conf/.env introuvable"
  exit 1
fi
. "${ENV_FILE}"

# --------- Variables dÃ©rivÃ©es utiles ---------
PID_FILE="${API_RUN}/${API_NAME}.pid"
SOCK_FILE="${API_SOCK}"
GUNICORN_CONF="${API_CONF}/gunicorn_conf.py"
WSGI_FILE="${API_BIN}/wsgi.py"

# --------- VÃ©rifications de base ---------
if [ ! -x "${API_VENV}/bin/activate" ]; then
  echo "[ERROR] Virtualenv introuvable ou non exÃ©cutable: ${API_VENV}/bin/activate"
  exit 1
fi
if [ ! -f "${GUNICORN_CONF}" ]; then
  echo "[ERROR] Fichier de configuration Gunicorn manquant: ${GUNICORN_CONF}"
  exit 1
fi
if [ ! -f "${WSGI_FILE}" ]; then
  echo "[ERROR] wsgi.py introuvable: ${WSGI_FILE}"
  exit 1
fi

# --------- CrÃ©ation des dossiers requis ---------
for d in "${API_RUN}" "${API_LOG}" "${API_CERTIFICATS}" "${API_WORK}" "${API_TMP}" \
         "${API_BUFFER}" "${API_UPLOADS}" "${API_DOWNLOADS}"; do
  [ -n "${d}" ] && [ ! -d "${d}" ] && mkdir -p "${d}"
done
# Dossier Flask "instance" (pour les fichiers de config runtime)
[ ! -d "${API_REPO}/instance" ] && mkdir -p "${API_REPO}/instance"

# --------- Gestion PID existant ---------
if [ -f "${PID_FILE}" ]; then
  OLD_PID="$(cat "${PID_FILE}" 2>/dev/null)"
  if [ -n "${OLD_PID}" ] && ps -p "${OLD_PID}" >/dev/null 2>&1; then
    echo "[WARN] ${API_NAME} dÃ©jÃ  dÃ©marrÃ© (PID=${OLD_PID})"
    echo "       Utilisez Stop.sh puis relancez si besoin."
    exit 0
  else
    echo "[INFO] PID obsolÃ¨te dÃ©tectÃ© -> nettoyage"
    rm -f "${PID_FILE}" >/dev/null 2>&1
  fi
fi

# --------- Nettoyage socket UNIX obsolÃ¨te ---------
if [ "${USE_UNIX_SOCKET}" = "true" ]; then
  if [ -S "${SOCK_FILE}" ]; then
    echo "[INFO] Suppression du socket obsolÃ¨te: ${SOCK_FILE}"
    rm -f "${SOCK_FILE}" >/dev/null 2>&1
  fi
fi

# --------- Purge TOTALE des pyc/pyo/__pycache__ ---------
find "${API_REPO}" -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null
find "${API_REPO}" -type f \( -name "*.pyc" -o -name "*.pyo" \) -delete 2>/dev/null

# --------- Activation du virtualenv ---------
. "${API_VENV}/bin/activate"

# --------- VÃ©rification de la conf Gunicorn ---------
if ! gunicorn --config "${GUNICORN_CONF}" --check-config >/dev/null 2>&1; then
  echo "[WARN] gunicorn --check-config a Ã©chouÃ© (vÃ©rifiez la conf), tentative de dÃ©marrage quand mÃªme..."
fi

# --------- DÃ©marrage de Gunicorn ---------
echo "[INFO] DÃ©marrage ${API_NAME} ..."
gunicorn --config "${GUNICORN_CONF}" wsgi:app &
GUNI_PID=$!

# --------- Ã‰criture du PID ---------
echo "${GUNI_PID}" > "${PID_FILE}"

# --------- Validation du dÃ©marrage ---------
W=${API_NB_WORKERS}
T=${API_NB_THREADS}
MARGE=3
max_wait=$(( W * T + MARGE ))
[ ${max_wait} -lt 5 ] && max_wait=5

i=0
while [ $i -lt $max_wait ]; do
  if ps -p "${GUNI_PID}" >/dev/null 2>&1; then
    if [ "${USE_UNIX_SOCKET}" = "true" ]; then
      echo "[OK] ${API_NAME} dÃ©marrÃ© (PID=${GUNI_PID}) [UNIX socket]"
      echo "     Socket : ${SOCK_FILE}"
    else
      echo "[OK] ${API_NAME} dÃ©marrÃ© (PID=${GUNI_PID}) [TCP ${API_HOST}:${API_PORT}]"
    fi
    break
  fi
  sleep 1; i=$((i+1))
done

if ! ps -p "${GUNI_PID}" >/dev/null 2>&1; then
  echo "[ERROR] Ã‰chec du dÃ©marrage ${API_NAME} (process non dÃ©tectÃ© dans ${max_wait}s)"
  rm -f "${PID_FILE}" >/dev/null 2>&1
  deactivate
  exit 1
fi

# --------- DÃ©sactivation du virtualenv ---------
deactivate

# --------- Afficher le statut courant ---------
"${API_BIN}/Status.sh"
