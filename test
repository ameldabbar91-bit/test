#!/bin/ksh
##############################################################################
#  AttachmentIntegratorApi - Status Script (final version)
#
#  âš™ï¸ UTILISATION AVEC SYSTEMD (recommandÃ©) :
#  -------------------------------------------------------------------------
#    sudo systemctl status attachementintegratorapi.service
#    sudo journalctl -u attachementintegratorapi.service -f
#
#  ðŸ§· MODE SOCKET UNIX :
#  -------------------------------------------------------------------------
#    - USE_UNIX_SOCKET=true dans conf/.env
#    - bind unix activÃ© dans conf/gunicorn_conf.py
#    - Ce script affiche la prÃ©sence du socket et son Ã©tat.
#
#  ðŸ’¡ INFORMATIONS AFFICHÃ‰ES :
#  -------------------------------------------------------------------------
#    - PID et Ã©tat du process Gunicorn
#    - Mode actif : TCP ou UNIX socket
#    - Endpoint ou socket dÃ©tectÃ©
#    - Nombre de workers / threads depuis .env
#
#  âš™ï¸ IMPACT SYSTEMD :
#  -------------------------------------------------------------------------
#    - Aucun changement requis : systemd ne gÃ¨re pas le socket ici.
#    - Gunicorn crÃ©e et gÃ¨re le socket lui-mÃªme si activÃ©.
#    - Un fichier .socket systemd serait possible, mais inutile ici.
##############################################################################

umask 027

# --------- Charger l'environnement ---------
ENV_FILE="$(dirname "$0")/../conf/.env"
if [ ! -f "${ENV_FILE}" ]; then
  echo "[ERROR] conf/.env introuvable"
  exit 1
fi
. "${ENV_FILE}"

# --------- Variables dÃ©rivÃ©es ---------
PID_FILE="${API_RUN}/${API_NAME}.pid"
SOCK_FILE="${API_SOCK}"
GUNICORN_CONF="${API_CONF}/gunicorn_conf.py"

# --------- Fonction utilitaire ---------
is_alive() {
  PID="$1"
  [ -n "${PID}" ] && ps -p "${PID}" >/dev/null 2>&1
}

echo "=== ${API_NAME} :: Status ==="
[ -f "${GUNICORN_CONF}" ] && echo "gunicorn_conf: ${GUNICORN_CONF}" || echo "gunicorn_conf: MISSING"
echo "workers=${API_NB_WORKERS} threads=${API_NB_THREADS}"

# --------- Cas sans PID ---------
if [ ! -f "${PID_FILE}" ]; then
  echo "PID file: ${PID_FILE} (absent)"
  if [ "${USE_UNIX_SOCKET}" = "true" ]; then
    if [ -S "${SOCK_FILE}" ]; then
      echo "socket: ${SOCK_FILE} (prÃ©sent sans PID) -> stale socket probable"
      exit 1
    fi
  fi
  echo "status: NOT RUNNING"
  exit 1
fi

# --------- Lire le PID ---------
PID="$(cat "${PID_FILE}" 2>/dev/null)"

# --------- PID vide ---------
if [ -z "${PID}" ]; then
  echo "PID file: ${PID_FILE} (vide)"
  echo "status: NOT RUNNING (stale pid)"
  exit 1
fi

# --------- VÃ©rification du process ---------
if is_alive "${PID}"; then
  echo "PID: ${PID} (alive)"
  if [ "${USE_UNIX_SOCKET}" = "true" ]; then
    echo "mode: UNIX socket"
    if [ -S "${SOCK_FILE}" ]; then
      echo "socket: ${SOCK_FILE} (prÃ©sent)"
      ss -xl 2>/dev/null | grep -q "$(basename "${SOCK_FILE}")" && echo "listen: detected by ss" || true
    else
      echo "socket: ${SOCK_FILE} (absent) -> vÃ©rifiez conf/gunicorn_conf.py et permissions ${API_RUN}"
    fi
  else
    echo "mode: TCP"
    echo "tcp: ${API_HOST}:${API_PORT}"
    ss -lntp 2>/dev/null | grep -q "${API_PORT}" && echo "listen: detected by ss" || true
  fi
  echo "status: RUNNING"
  exit 0
else
  echo "PID: ${PID} (dead)"
  if [ "${USE_UNIX_SOCKET}" = "true" ] && [ -S "${SOCK_FILE}" ]; then
    echo "socket: ${SOCK_FILE} (prÃ©sent sans process) -> stale socket"
  fi
  echo "status: NOT RUNNING (stale pid)"
  exit 1
fi

##############################################################################
# ðŸ§­ UTILISATION RAPIDE :
# ---------------------------------------------------------------------------
#   ./Status.sh
#   echo $?           # 0 = OK, 1 = NOT RUNNING
#
#   Avec systemd :
#     sudo systemctl status attachementintegratorapi.service
#     sudo journalctl -u attachementintegratorapi.service -f
#
#   VÃ©rif manuelle socket :
#     ss -xl | grep gunicorn.sock
##############################################################################
