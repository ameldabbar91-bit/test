# -*- coding: utf-8 -*-
import os

API_NAME  = os.getenv("API_NAME", "AttachmentIntegratorApi")
API_HOST  = os.getenv("API_HOST", "127.0.0.1")
API_PORT  = int(os.getenv("API_PORT", "8410"))
API_BIN   = os.getenv("API_BIN")                   # ex: /.../AttachmentIntegratorApi/bin
API_RUN   = os.getenv("API_RUN", "/tmp")
API_LOG   = os.getenv("API_LOG", "/tmp")
USE_UNIX  = os.getenv("USE_UNIX_SOCKET", "false").lower() == "true"
API_SOCK  = os.getenv("API_SOCK", os.path.join(API_RUN, "gunicorn.sock"))

# — clé de voûte : placement + module WSGI —
chdir    = API_BIN                     # Gunicorn se place dans .../bin
wsgi_app = "app.wsgi:app"              # charge app depuis app/wsgi.py

bind = f"unix:{API_SOCK}" if USE_UNIX else f"{API_HOST}:{API_PORT}"

workers  = int(os.getenv("API_NB_WORKERS", "2"))
threads  = int(os.getenv("API_NB_THREADS", "1"))
timeout  = int(os.getenv("API_TIMEOUT", "120"))
graceful_timeout = int(os.getenv("API_GRACEFUL_TIMEOUT", "30"))
keepalive = int(os.getenv("API_KEEPALIVE", "5"))
worker_class = os.getenv("API_WORKER_CLASS", "sync")
max_requests = int(os.getenv("API_MAX_REQUESTS", "1000"))
max_requests_jitter = int(os.getenv("API_MAX_REQUESTS_JITTER", "50"))

pidfile     = os.path.join(API_RUN, f"{API_NAME}.pid")
errorlog    = os.path.join(API_LOG, "gunicorn.error.log")
accesslog   = os.path.join(API_LOG, "gunicorn.access.log")
loglevel    = os.getenv("LOG_LEVEL", "info").lower()
capture_output = True
print_config   = True
proc_name      = API_NAME
umask          = 0o27

def when_ready(server):
    print(f"[when_ready] {API_NAME} prêt. bind={bind} workers={workers} threads={threads}")
