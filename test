import psutil
import time
from statistics import mean, deque

# Dictionnaire global pour stocker les temps de réponse
request_times = deque(maxlen=100)  # moyenne glissante sur 100 requêtes max

def record_response_time(duration: float):
    """Ajoute un temps de réponse dans l'historique."""
    request_times.append(duration)

def get_average_response_time():
    """Retourne le temps moyen de réponse en ms."""
    if not request_times:
        return 0.0
    return round(mean(request_times), 2)

def get_system_metrics():
    """Retourne CPU, RAM, uptime du système."""
    return {
        "cpu_percent": psutil.cpu_percent(interval=0.2),
        "memory_percent": psutil.virtual_memory().percent,
        "uptime_seconds": int(time.time() - psutil.boot_time()),
    }
