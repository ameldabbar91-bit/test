import os
import oracledb
from flask_sqlalchemy import SQLAlchemy
from flask import current_app

db = SQLAlchemy()


def init_sqlalchemy(app=None) -> None:
    """
    Initialise SQLAlchemy pour une base Oracle.

    - lit la conf dans les variables d'environnement :
        ORACLE_USER
        ORACLE_PASSWORD
        ORACLE_HOST      (par défaut: localhost)
        ORACLE_PORT      (par défaut: 1521)
        ORACLE_SERVICE_NAME  ou ORACLE_SID
        ORACLE_CLIENT_LIB_DIR (chemin du client Oracle optionnel)
        ORACLE_CONFIG_DIR     (tnsnames.ora, sqlnet.ora, … optionnel)
    - initialise oracledb.init_oracle_client (une seule fois)
    - configure app.config['SQLALCHEMY_DATABASE_URI']
    - attache l'instance db à l’app
    """
    if app is None:
        app = current_app

    # --- Initialisation du client Oracle (optionnelle) ---
    kw = {}
    lib_dir = os.getenv("ORACLE_CLIENT_LIB_DIR")
    config_dir = os.getenv("ORACLE_CONFIG_DIR")
    if lib_dir:
        kw["lib_dir"] = lib_dir
    if config_dir:
        kw["config_dir"] = config_dir

    if kw:
        try:
            oracledb.init_oracle_client(**kw)
        except oracledb.ProgrammingError:
            # déjà initialisé → on ignore
            pass

    # --- Construction de l'URL SQLAlchemy ---
    user = os.environ.get("ORACLE_USER")
    password = os.environ.get("ORACLE_PASSWORD")
    host = os.getenv("ORACLE_HOST", "localhost")
    port = os.getenv("ORACLE_PORT", "1521")
    service_name = os.environ.get("ORACLE_SERVICE_NAME")
    sid = os.environ.get("ORACLE_SID")

    if not user or not password:
        raise RuntimeError("ORACLE_USER et ORACLE_PASSWORD doivent être définis.")

    if service_name:
        # Connexion via service_name
        dsn = f"{host}:{port}/?service_name={service_name}"
    elif sid:
        # Connexion via SID
        dsn = f"{host}:{port}/{sid}"
    else:
        raise RuntimeError("Définir ORACLE_SERVICE_NAME ou ORACLE_SID.")

    db_uri = f"oracle+oracledb://{user}:{password}@{dsn}"

    # --- Configuration de Flask / SQLAlchemy ---
    app.config.setdefault("SQLALCHEMY_DATABASE_URI", db_uri)
    app.config.setdefault("SQLALCHEMY_TRACK_MODIFICATIONS", False)
    app.config.setdefault("SQLALCHEMY_ENGINE_OPTIONS", {"pool_pre_ping": True})

    db.init_app(app)
